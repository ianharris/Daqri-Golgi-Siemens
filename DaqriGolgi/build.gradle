apply plugin: 'java'

sourceCompatibility = 1.5
version = '1.0'

repositories {
    mavenCentral()
}

def golgiGenDir = 'src/main/java/io/golgi/daqri/gen'
def thriftFileName = '../Daqri.thrift'
def golgiPkgDir = System.properties['user.home'] + '/Golgi-Pkg/LATEST/common/'
def golgiGenPkg = 'io.golgi.daqri.gen'
def GolgiAppKey = '../Golgi.AppKey'
def GolgiDevKey = '../Golgi.DevKey'

task(cleanGolgi,type: JavaExec){
    main 'com.openmindnetworks.golgi.garrick.Garrick'
    classpath fileTree(dir:golgiPkgDir, includes: ['garrick_combined.jar'])
    args '-clean','-i',thriftFileName,'-jo',golgiGenDir
}

task(buildGolgi, type: JavaExec){
    main 'com.openmindnetworks.golgi.garrick.Garrick'
    classpath fileTree(dir: golgiPkgDir,includes: ['garrick_combined.jar'])
    args '-i',thriftFileName,'-jo',golgiGenDir
}

task mkGolgiGenDir << {
    project.file(golgiGenDir).mkdir()
    println 'Making Golgi Gen directory'
}

task mkGolgiKeyFiles <<{
    String appKey = project.file(GolgiAppKey).text;
    appKey = appKey.trim();
    String devKey = project.file(GolgiDevKey).text;
    devKey = devKey.trim();
    project.file(golgiGenDir + '/GolgiKeys.java').withWriter { out ->
        out.writeLine("/* IS_AUTOGENERATED_SO_ALLOW_AUTODELETE=YES */");
        out.writeLine("/* The previous line is to allow auto deletion */");
        out.writeLine("package " + golgiGenPkg + ";");
        out.writeLine("public class GolgiKeys{");
        out.writeLine("    public static final String DEV_KEY = \"" + devKey + "\";");
        out.writeLine("    public static final String APP_KEY = \"" + appKey + "\";");
        out.writeLine("}");
    }
}

buildGolgi.dependsOn mkGolgiKeyFiles
mkGolgiKeyFiles.dependsOn mkGolgiGenDir
clean.dependsOn cleanGolgi
compileJava.dependsOn buildGolgi

dependencies {
    testCompile group: 'junit', name: 'junit', version: '4.11'
    compile fileTree(dir: golgiPkgDir, include: 'golgi_j2se.jar')
}
